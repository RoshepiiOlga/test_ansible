---
- hosts: all
  gather_facts: yes
  tasks:
    - name: gather os specific variables
      include_vars: "{{ item }}"
      with_first_found:
          - "vars/{{ ansible_distribution }}.yaml"

    - name: Download zabbix repo package
      get_url:
          url: "{{ zabbix_repo_url}}"
          dest: /tmp/zabbix.deb

    - name: Install zabbix repo
      become: yes
      apt:
          deb: /tmp/zabbix.deb
          state: present

    - name: Install zabbix agent
      become: yes
      apt:
          name: zabbix-agent
          state: present
          update_cache: yes

    - name: Stop service zabbix-agent
      become: yes
      service:
          name: zabbix-agent
          state: stopped

    - name: Remove zabbix config file
      become: yes
      file:
          path: /etc/zabbix/zabbix_agentd.conf
          state: absent

    - name: Create new zabbix config file from template
      become: yes
      template:
          src: "templates/zabbix_agentd.conf.j2"
          dest: "/etc/zabbix/zabbix_agentd.conf"

    - name: Start service zabbix-agent
      become: yes
      service:
          name: zabbix-agent
          state: started
#---
##### Install zabbix-agent
#  - name: ping hosts
#    ping: 52.49.17.176

#  - name: check OS
#    debug: msg={{ansible_distribution}}-{{ansible_distribution_version}}
### Ubuntu 18.04 Bionic Beaver
#  - name: download zabbix deb file fot Ubuntu 18.04
#    get_url:
#      url: "{{ ubuntu18_link }}"
#      dest: "/tmp/{{ ubuntu18_file }}"
#    when: ansible_distribution_release == 'bionic'

#  - name: install zabbix deb for Ubuntu 18.04 Xenial
#    apt: deb="/tmp/{{ ubuntu18_file }}"
#    when: ansible_distribution_release == 'bionic'

#  - name: install zabbix-agent 4.4 Ubuntu 18.04
#    apt:
#      name: zabbix-agent
#      state: latest
#      update_cache: yes
#    when: ansible_distribution_release == 'bionic'

##### enabled zabbix-agent
#  - name: enable service zabbix-agent and ensure it is not masked
#    systemd:
#      name: zabbix-agent
#      enabled: yes
#      masked: no
#    become: yes

##### check zabbix home dir and shell
#  - name: Make sure a service is stopped
#    systemd: state=stopped name=zabbix-agent
#    become: yes

#  - name: check zabbix home dir and shell
#    user:
#      name: zabbix
#      shell: /bin/bash
#      home: /etc/zabbix
#    become: yes

##### mkdir /etc/zabbix/scripts and rights
#  - name: mkdir /etc/zabbix/scripts and rights
#    file:
#      path: /etc/zabbix/scripts
#      state: directory
#      owner: zabbix
#      group: zabbix
#      mode: 0700
#    become: yes

##### change zabbix_agentd.conf
#  - name: change zabbix_agentd.conf Hostname
#    lineinfile:
#      path: /etc/zabbix/zabbix_agentd.conf
#      state: present
#      regexp: 'Hostname=Zabbix server'
#      line: "Hostname={{ ansible_hostname }}"
#    become: yes
#
#  - name: change zabbix_agentd.conf ServerActive
#    lineinfile:
#      path: /etc/zabbix/zabbix_agentd.conf
#      state: present
#      regexp: 'ServerActive=127.0.0.1'
#      line: "ServerActive={{ zbx_srv }}"
#    become: yes

#  - name: change zabbix_agentd.conf Server
#    lineinfile:
 #     path: /etc/zabbix/zabbix_agentd.conf
#      state: present
#      regexp: 'Server=127.0.0.1'
#      line: "Server={{ zbx_srv }}"
#    become: yes

#  - name: change zabbix_agentd.conf EnableRemoteCommands
#    lineinfile:
#      path: /etc/zabbix/zabbix_agentd.conf
#      state: present
#      regexp: '# EnableRemoteCommands=0'
#      line: 'EnableRemoteCommands=1'
#    become: yes

#  - name: change zabbix_agentd.conf LogRemoteCommands
#    lineinfile:
#      path: /etc/zabbix/zabbix_agentd.conf
#      state: present
#      regexp: '# LogRemoteCommands=0'
#      line: 'LogRemoteCommands=1'
### Starting zabbix-agent
#  - name: Make sure a service is started
#    systemd: state=started name=zabbix-agent
#    become: yes      